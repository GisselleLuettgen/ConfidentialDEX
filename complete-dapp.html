<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšç§DeFiå¹³å° - Privacy DEX & FundPad</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298, #1a237e);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }

        .wallet-status {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .input-group input::placeholder, .input-group textarea::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .project-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .trading-pair {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }

        .close:hover {
            color: #ff6b6b;
        }

        .status-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-active {
            background: #4caf50;
        }

        .status-completed {
            background: #2196f3;
        }

        .status-failed {
            background: #f44336;
        }

        .flex-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .error {
            color: #ff6b6b;
            margin-top: 10px;
        }

        .success {
            color: #4caf50;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .navigation {
                flex-direction: column;
                align-items: center;
            }
            
            .wallet-status {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” éšç§DeFiå¹³å°</h1>
            <p>åŸºäºZama FHEçš„éšç§ä¿æŠ¤å»ä¸­å¿ƒåŒ–é‡‘èå¹³å°</p>
        </div>

        <div class="wallet-status">
            <div>
                <span id="wallet-status">æœªè¿æ¥é’±åŒ…</span>
                <div id="wallet-info" style="display:none;">
                    <div>åœ°å€: <span id="wallet-address"></span></div>
                    <div>ä½™é¢: <span id="wallet-balance"></span> ETH</div>
                    <div>ç½‘ç»œ: <span id="network-info"></span></div>
                </div>
            </div>
            <button id="connect-wallet" class="btn">è¿æ¥MetaMask</button>
        </div>

        <div class="navigation">
            <button class="nav-btn active" onclick="showPage('home')">é¦–é¡µ</button>
            <button class="nav-btn" onclick="showPage('fundpad')">ç­¹æ¬¾å¹³å°</button>
            <button class="nav-btn" onclick="showPage('dex')">éšç§DEX</button>
        </div>

        <!-- é¦–é¡µ -->
        <div id="home" class="page active">
            <div class="card">
                <h2>æ¬¢è¿æ¥åˆ°éšç§DeFiå¹³å°</h2>
                <p>è¿™æ˜¯ä¸€ä¸ªåŸºäºZama FHEæŠ€æœ¯çš„éšç§ä¿æŠ¤DeFiå¹³å°ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
                <ul style="margin: 20px 0; padding-left: 20px;">
                    <li><strong>éšç§ç­¹æ¬¾å¹³å°(FundPad)</strong>: åˆ›å»ºå’ŒæŠ•èµ„éšç§ä¿æŠ¤çš„ç­¹æ¬¾é¡¹ç›®</li>
                    <li><strong>éšç§DEX</strong>: è¿›è¡Œéšç§ä¿æŠ¤çš„ä»£å¸äº¤æ˜“</li>
                    <li><strong>MetaMaské›†æˆ</strong>: æ— ç¼çš„é’±åŒ…è¿æ¥å’Œäº¤æ˜“ä½“éªŒ</li>
                </ul>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="showPage('fundpad')">å¼€å§‹ç­¹æ¬¾</button>
                    <button class="btn" onclick="showPage('dex')">å¼€å§‹äº¤æ˜“</button>
                </div>
            </div>
        </div>

        <!-- ç­¹æ¬¾å¹³å°é¡µé¢ -->
        <div id="fundpad" class="page">
            <div class="card">
                <h2>ç­¹æ¬¾å¹³å°</h2>
                <button class="btn" onclick="openCreateProjectModal()">åˆ›å»ºæ–°é¡¹ç›®</button>
                <button class="btn" onclick="loadProjects()">åˆ·æ–°é¡¹ç›®åˆ—è¡¨</button>
            </div>

            <div id="projects-container">
                <div class="projects-grid" id="projects-list">
                    <!-- é¡¹ç›®åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>

        <!-- DEXé¡µé¢ -->
        <div id="dex" class="page">
            <div class="card">
                <h2>éšç§DEXäº¤æ˜“</h2>
                <p>åœ¨è¿™é‡Œè¿›è¡Œéšç§ä¿æŠ¤çš„ä»£å¸äº¤æ˜“</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <h3>å­˜å…¥èµ„é‡‘</h3>
                        <div class="input-group">
                            <label>å­˜å…¥ETHæ•°é‡:</label>
                            <input type="number" id="deposit-amount" placeholder="0.1" step="0.01">
                        </div>
                        <button class="btn" onclick="depositETH()">å­˜å…¥ETH</button>
                    </div>
                    
                    <div>
                        <h3>äº¤æ˜“</h3>
                        <div class="input-group">
                            <label>å–å‡ºä»£å¸:</label>
                            <select id="token-in">
                                <option value="0x0000000000000000000000000000000000000000">ETH</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>ä¹°å…¥ä»£å¸:</label>
                            <select id="token-out">
                                <option value="0x0000000000000000000000000000000000000000">ETH</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>å–å‡ºæ•°é‡:</label>
                            <input type="number" id="trade-amount-in" placeholder="0.1" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>æœŸæœ›ä¹°å…¥æ•°é‡:</label>
                            <input type="number" id="trade-amount-out" placeholder="0.1" step="0.01">
                        </div>
                        <button class="btn" onclick="createTradeOrder()">åˆ›å»ºäº¤æ˜“è®¢å•</button>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>æˆ‘çš„è®¢å•</h3>
                    <div id="user-orders">
                        <!-- ç”¨æˆ·è®¢å•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºé¡¹ç›®æ¨¡æ€æ¡† -->
    <div id="create-project-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateProjectModal()">&times;</span>
            <h2>åˆ›å»ºæ–°é¡¹ç›®</h2>
            <form id="create-project-form">
                <div class="input-group">
                    <label>é¡¹ç›®åç§°:</label>
                    <input type="text" id="project-name" required>
                </div>
                <div class="input-group">
                    <label>é¡¹ç›®æè¿°:</label>
                    <textarea id="project-description" rows="4" required></textarea>
                </div>
                <div class="input-group">
                    <label>ç›®æ ‡é‡‘é¢ (ETH):</label>
                    <input type="number" id="project-target" step="0.01" required>
                </div>
                <div class="input-group">
                    <label>ç­¹æ¬¾æœŸé™ (å¤©):</label>
                    <input type="number" id="project-duration" min="1" required>
                </div>
                <button type="submit" class="btn">åˆ›å»ºé¡¹ç›®</button>
            </form>
            <div id="create-project-status"></div>
        </div>
    </div>

    <!-- é¡¹ç›®è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="project-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeProjectDetailModal()">&times;</span>
            <div id="project-detail-content">
                <!-- é¡¹ç›®è¯¦æƒ…å†…å®¹ -->
            </div>
        </div>
    </div>

    <script>
        // æ™ºèƒ½åˆçº¦é…ç½®
        const FUNDPAD_CONTRACT_ADDRESS = "0x4B4A5F9a4d4c4e4f4A5f4A5f4A5f4A5f4A5f4A5f"; // æ›¿æ¢ä¸ºå®é™…åœ°å€
        const DEX_CONTRACT_ADDRESS = "0x5C5B6F5a5d5c5e5f5B5f5B5f5B5f5B5f5B5f5B5f"; // æ›¿æ¢ä¸ºå®é™…åœ°å€
        
        // FHEVMé…ç½®
        const FHEVM_CONFIG = {
            executor: "0x848B0066793BcC60346Da1F49049357399B8D595",
            acl: "0x687820221192C5B662b25367F70076A37bc79b6c",
            kmsVerifier: "0x1364cBBf2cDF5032C47d8226a6f6FBD2AFCDacAC",
            inputVerifier: "0xbc91f3daD1A5F19F8390c400196e58073B6a0BC4",
            decryptionOracle: "0xa02Cda4Ca3a71D7C46997716F4283aa851C28812"
        };

        // å…¨å±€å˜é‡
        let provider = null;
        let signer = null;
        let userAccount = null;
        let fundpadContract = null;
        let dexContract = null;

        // æ™ºèƒ½åˆçº¦ABI (ç®€åŒ–ç‰ˆ)
        const FUNDPAD_ABI = [
            "function createProject(string memory _name, string memory _description, uint256 _targetAmount, uint256 _duration) external returns (uint256)",
            "function contribute(uint256 _projectId, bytes memory _encryptedAmount, bytes memory _inputProof) external payable",
            "function getProject(uint256 _projectId) external view returns (tuple(uint256 id, address creator, string name, string description, uint256 targetAmount, uint256 deadline, uint256 encryptedRaised, uint64 decryptedRaised, bool isActive, bool isDecrypted, uint8 status))",
            "function getAllActiveProjects() external view returns (uint256[] memory)",
            "function totalProjects() external view returns (uint256)",
            "event ProjectCreated(uint256 indexed projectId, address indexed creator, string name, uint256 targetAmount, uint256 deadline)",
            "event ContributionMade(uint256 indexed projectId, address indexed contributor, uint256 amount)"
        ];

        const DEX_ABI = [
            "function depositETH(bytes memory _encryptedAmount, bytes memory _inputProof) external payable",
            "function createOrder(address _tokenIn, address _tokenOut, bytes memory _encryptedAmountIn, bytes memory _encryptedAmountOut, bytes memory _inputProofIn, bytes memory _inputProofOut, uint8 _orderType) external returns (uint256)",
            "function getUserOrders(address _user) external view returns (uint256[] memory)",
            "function getOrder(uint256 _orderId) external view returns (tuple(uint256 id, address trader, address tokenIn, address tokenOut, uint256 encryptedAmountIn, uint256 encryptedAmountOut, uint64 decryptedAmountIn, uint64 decryptedAmountOut, bool isActive, bool isDecrypted, uint8 orderType, uint8 status))",
            "event OrderCreated(uint256 indexed orderId, address indexed trader, uint8 orderType)"
        ];

        // åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask is installed!');
                await checkConnection();
            } else {
                console.log('MetaMask is not installed');
                document.getElementById('wallet-status').textContent = 'Please install MetaMask';
            }
        });

        // æ£€æŸ¥é’±åŒ…è¿æ¥çŠ¶æ€
        async function checkConnection() {
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                const accounts = await provider.listAccounts();
                
                if (accounts.length > 0) {
                    await connectWallet();
                }
            } catch (error) {
                console.error('Error checking connection:', error);
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    alert('è¯·å®‰è£…MetaMaské’±åŒ…');
                    return;
                }

                // è¯·æ±‚è¿æ¥
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAccount = await signer.getAddress();
                
                // åˆå§‹åŒ–åˆçº¦å®ä¾‹
                fundpadContract = new ethers.Contract(FUNDPAD_CONTRACT_ADDRESS, FUNDPAD_ABI, signer);
                dexContract = new ethers.Contract(DEX_CONTRACT_ADDRESS, DEX_ABI, signer);
                
                await updateWalletDisplay();
                
                // ç›‘å¬è´¦æˆ·å˜åŒ–
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);
                
            } catch (error) {
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                alert('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°é’±åŒ…æ˜¾ç¤º
        async function updateWalletDisplay() {
            try {
                const balance = await provider.getBalance(userAccount);
                const network = await provider.getNetwork();
                
                document.getElementById('wallet-status').textContent = 'é’±åŒ…å·²è¿æ¥';
                document.getElementById('wallet-address').textContent = 
                    userAccount.substring(0, 6) + '...' + userAccount.substring(38);
                document.getElementById('wallet-balance').textContent = 
                    ethers.utils.formatEther(balance).substring(0, 6);
                document.getElementById('network-info').textContent = 
                    network.name + ' (Chain ID: ' + network.chainId + ')';
                
                document.getElementById('wallet-info').style.display = 'block';
                document.getElementById('connect-wallet').textContent = 'æ–­å¼€è¿æ¥';
                document.getElementById('connect-wallet').onclick = disconnectWallet;
                
            } catch (error) {
                console.error('æ›´æ–°é’±åŒ…æ˜¾ç¤ºå¤±è´¥:', error);
            }
        }

        // æ–­å¼€é’±åŒ…è¿æ¥
        function disconnectWallet() {
            provider = null;
            signer = null;
            userAccount = null;
            fundpadContract = null;
            dexContract = null;
            
            document.getElementById('wallet-status').textContent = 'æœªè¿æ¥é’±åŒ…';
            document.getElementById('wallet-info').style.display = 'none';
            document.getElementById('connect-wallet').textContent = 'è¿æ¥MetaMask';
            document.getElementById('connect-wallet').onclick = connectWallet;
        }

        // å¤„ç†è´¦æˆ·å˜åŒ–
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                disconnectWallet();
            } else {
                connectWallet();
            }
        }

        // å¤„ç†ç½‘ç»œå˜åŒ–
        function handleChainChanged(chainId) {
            window.location.reload();
        }

        // é¡µé¢å¯¼èˆª
        function showPage(pageId) {
            // éšè—æ‰€æœ‰é¡µé¢
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªæŒ‰é’®çš„activeç±»
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => btn.classList.remove('active'));
            
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            document.getElementById(pageId).classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„å¯¼èˆªæŒ‰é’®
            event.target.classList.add('active');
            
            // å¦‚æœæ˜¯ç­¹æ¬¾é¡µé¢ï¼ŒåŠ è½½é¡¹ç›®
            if (pageId === 'fundpad') {
                loadProjects();
            } else if (pageId === 'dex') {
                loadUserOrders();
            }
        }

        // æ¨¡æ€æ¡†æ§åˆ¶
        function openCreateProjectModal() {
            if (!userAccount) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }
            document.getElementById('create-project-modal').style.display = 'block';
        }

        function closeCreateProjectModal() {
            document.getElementById('create-project-modal').style.display = 'none';
            document.getElementById('create-project-form').reset();
            document.getElementById('create-project-status').innerHTML = '';
        }

        function closeProjectDetailModal() {
            document.getElementById('project-detail-modal').style.display = 'none';
        }

        // åˆ›å»ºé¡¹ç›®
        async function createProject(event) {
            event.preventDefault();
            
            if (!fundpadContract) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }

            const statusDiv = document.getElementById('create-project-status');
            statusDiv.innerHTML = '<div style="color: yellow;">æ­£åœ¨åˆ›å»ºé¡¹ç›®...</div>';

            try {
                const name = document.getElementById('project-name').value;
                const description = document.getElementById('project-description').value;
                const targetAmount = ethers.utils.parseEther(document.getElementById('project-target').value);
                const duration = parseInt(document.getElementById('project-duration').value) * 24 * 60 * 60; // è½¬æ¢ä¸ºç§’

                // è°ƒç”¨æ™ºèƒ½åˆçº¦åˆ›å»ºé¡¹ç›®
                const tx = await fundpadContract.createProject(name, description, targetAmount, duration);
                
                statusDiv.innerHTML = '<div style="color: yellow;">äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...</div>';
                
                const receipt = await tx.wait();
                
                statusDiv.innerHTML = '<div class="success">é¡¹ç›®åˆ›å»ºæˆåŠŸï¼</div>';
                
                // å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°é¡¹ç›®åˆ—è¡¨
                setTimeout(() => {
                    closeCreateProjectModal();
                    loadProjects();
                }, 2000);
                
            } catch (error) {
                console.error('åˆ›å»ºé¡¹ç›®å¤±è´¥:', error);
                statusDiv.innerHTML = '<div class="error">åˆ›å»ºé¡¹ç›®å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // åŠ è½½é¡¹ç›®åˆ—è¡¨
        async function loadProjects() {
            if (!fundpadContract) {
                document.getElementById('projects-list').innerHTML = '<p>è¯·å…ˆè¿æ¥é’±åŒ…</p>';
                return;
            }

            try {
                const projectIds = await fundpadContract.getAllActiveProjects();
                const projectsContainer = document.getElementById('projects-list');
                
                if (projectIds.length === 0) {
                    projectsContainer.innerHTML = '<p>æš‚æ— æ´»è·ƒé¡¹ç›®</p>';
                    return;
                }

                let projectsHTML = '';
                
                for (let id of projectIds) {
                    try {
                        const project = await fundpadContract.getProject(id);
                        const deadline = new Date(project.deadline * 1000);
                        const isExpired = Date.now() > deadline.getTime();
                        
                        projectsHTML += `
                            <div class="project-card">
                                <h3>${project.name}</h3>
                                <p>${project.description}</p>
                                <div style="margin: 15px 0;">
                                    <div>ç›®æ ‡: ${ethers.utils.formatEther(project.targetAmount)} ETH</div>
                                    <div>åˆ›å»ºè€…: ${project.creator.substring(0, 6)}...${project.creator.substring(38)}</div>
                                    <div>æˆªæ­¢æ—¶é—´: ${deadline.toLocaleDateString()}</div>
                                    <div>çŠ¶æ€: <span class="status-indicator ${project.isActive ? 'status-active' : 'status-completed'}">${project.isActive ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ'}</span></div>
                                </div>
                                ${project.isActive && !isExpired ? `
                                    <div style="margin-top: 15px;">
                                        <input type="number" id="contribute-${id}" placeholder="æŠ•èµ„é‡‘é¢(ETH)" step="0.01" style="margin-bottom: 10px;">
                                        <button class="btn" onclick="contributeToProject(${id})">æŠ•èµ„é¡¹ç›®</button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    } catch (error) {
                        console.error(`Error loading project ${id}:`, error);
                    }
                }
                
                projectsContainer.innerHTML = projectsHTML;
                
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('projects-list').innerHTML = '<p>åŠ è½½é¡¹ç›®å¤±è´¥</p>';
            }
        }

        // æŠ•èµ„é¡¹ç›®
        async function contributeToProject(projectId) {
            if (!fundpadContract) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }

            const amountInput = document.getElementById(`contribute-${projectId}`);
            const amount = amountInput.value;
            
            if (!amount || parseFloat(amount) <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ•èµ„é‡‘é¢');
                return;
            }

            try {
                const weiAmount = ethers.utils.parseEther(amount);
                
                // è¿™é‡Œéœ€è¦å®ç°FHEåŠ å¯†é€»è¾‘
                // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨ç®€åŒ–çš„æ–¹å¼
                const encryptedAmount = "0x" + "0".repeat(64); // ç®€åŒ–çš„åŠ å¯†æ•°æ®
                const inputProof = "0x" + "0".repeat(128); // ç®€åŒ–çš„è¯æ˜æ•°æ®
                
                const tx = await fundpadContract.contribute(
                    projectId,
                    encryptedAmount,
                    inputProof,
                    { value: weiAmount }
                );
                
                alert('äº¤æ˜“å·²æäº¤ï¼Œè¯·ç­‰å¾…ç¡®è®¤...');
                
                const receipt = await tx.wait();
                
                alert('æŠ•èµ„æˆåŠŸï¼');
                amountInput.value = '';
                loadProjects(); // åˆ·æ–°é¡¹ç›®åˆ—è¡¨
                
            } catch (error) {
                console.error('æŠ•èµ„å¤±è´¥:', error);
                alert('æŠ•èµ„å¤±è´¥: ' + error.message);
            }
        }

        // DEXåŠŸèƒ½
        async function depositETH() {
            if (!dexContract) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }

            const amount = document.getElementById('deposit-amount').value;
            if (!amount || parseFloat(amount) <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢');
                return;
            }

            try {
                const weiAmount = ethers.utils.parseEther(amount);
                
                // ç®€åŒ–çš„åŠ å¯†æ•°æ®
                const encryptedAmount = "0x" + "0".repeat(64);
                const inputProof = "0x" + "0".repeat(128);
                
                const tx = await dexContract.depositETH(encryptedAmount, inputProof, {
                    value: weiAmount
                });
                
                alert('äº¤æ˜“å·²æäº¤ï¼Œè¯·ç­‰å¾…ç¡®è®¤...');
                const receipt = await tx.wait();
                alert('å­˜å…¥æˆåŠŸï¼');
                
                document.getElementById('deposit-amount').value = '';
                
            } catch (error) {
                console.error('å­˜å…¥å¤±è´¥:', error);
                alert('å­˜å…¥å¤±è´¥: ' + error.message);
            }
        }

        async function createTradeOrder() {
            if (!dexContract) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }

            const tokenIn = document.getElementById('token-in').value;
            const tokenOut = document.getElementById('token-out').value;
            const amountIn = document.getElementById('trade-amount-in').value;
            const amountOut = document.getElementById('trade-amount-out').value;

            if (!amountIn || !amountOut || parseFloat(amountIn) <= 0 || parseFloat(amountOut) <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„äº¤æ˜“é‡‘é¢');
                return;
            }

            try {
                // ç®€åŒ–çš„åŠ å¯†æ•°æ®
                const encryptedAmountIn = "0x" + "0".repeat(64);
                const encryptedAmountOut = "0x" + "0".repeat(64);
                const inputProofIn = "0x" + "0".repeat(128);
                const inputProofOut = "0x" + "0".repeat(128);
                
                const tx = await dexContract.createOrder(
                    tokenIn,
                    tokenOut,
                    encryptedAmountIn,
                    encryptedAmountOut,
                    inputProofIn,
                    inputProofOut,
                    0 // OrderType.Buy
                );
                
                alert('äº¤æ˜“è®¢å•å·²æäº¤ï¼Œè¯·ç­‰å¾…ç¡®è®¤...');
                const receipt = await tx.wait();
                alert('è®¢å•åˆ›å»ºæˆåŠŸï¼');
                
                // æ¸…ç©ºè¾“å…¥
                document.getElementById('trade-amount-in').value = '';
                document.getElementById('trade-amount-out').value = '';
                
                loadUserOrders();
                
            } catch (error) {
                console.error('åˆ›å»ºè®¢å•å¤±è´¥:', error);
                alert('åˆ›å»ºè®¢å•å¤±è´¥: ' + error.message);
            }
        }

        async function loadUserOrders() {
            if (!dexContract || !userAccount) {
                document.getElementById('user-orders').innerHTML = '<p>è¯·å…ˆè¿æ¥é’±åŒ…</p>';
                return;
            }

            try {
                const orderIds = await dexContract.getUserOrders(userAccount);
                const ordersContainer = document.getElementById('user-orders');
                
                if (orderIds.length === 0) {
                    ordersContainer.innerHTML = '<p>æš‚æ— è®¢å•</p>';
                    return;
                }

                let ordersHTML = '<h4>æˆ‘çš„äº¤æ˜“è®¢å•:</h4>';
                
                for (let id of orderIds) {
                    try {
                        const order = await dexContract.getOrder(id);
                        ordersHTML += `
                            <div class="trading-pair">
                                <div>è®¢å•ID: ${id}</div>
                                <div>ç±»å‹: ${order.orderType === 0 ? 'ä¹°å…¥' : 'å–å‡º'}</div>
                                <div>çŠ¶æ€: ${order.isActive ? 'æ´»è·ƒ' : 'å·²å®Œæˆ'}</div>
                            </div>
                        `;
                    } catch (error) {
                        console.error(`Error loading order ${id}:`, error);
                    }
                }
                
                ordersContainer.innerHTML = ordersHTML;
                
            } catch (error) {
                console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
                document.getElementById('user-orders').innerHTML = '<p>åŠ è½½è®¢å•å¤±è´¥</p>';
            }
        }

        // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
        document.getElementById('create-project-form').addEventListener('submit', createProject);
        document.getElementById('connect-wallet').addEventListener('click', connectWallet);

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const createModal = document.getElementById('create-project-modal');
            const detailModal = document.getElementById('project-detail-modal');
            
            if (event.target == createModal) {
                closeCreateProjectModal();
            }
            if (event.target == detailModal) {
                closeProjectDetailModal();
            }
        }
    </script>
</body>
</html>